extends ../../layouts/default.pug
include ../../mixins/box-head.pug
include ../../mixins/alert.pug

block main
  +alert-success(3000)

  .product-detail
    .container.my-5
      .row
        .detail-phone 
          .inner-thumb
            button.main-arrow.left-main-arrow.disabled &lt;
            img(src=product.thumbnail, alt=product.title, id="main-image")
            button.main-arrow.right-main-arrow &gt;
          .thumb-images-wrapper
            button.thumb-arrow.left-arrow &lt;
            .thumb-images.swiper-container
              .swiper-wrapper
                // Hiển thị ảnh chính đầu tiên, sau đó là các ảnh khác
                .swiper-slide
                  img(src=product.thumbnail, alt=product.title, class="product-image selected", data-index=0)
                each image, index in product.images
                  // Chỉ hiển thị ảnh nếu khác với ảnh chính
                  if image !== product.thumbnail
                    .swiper-slide
                      img(src=image, alt=product.title, class="product-image", data-index=index + 1)
            button.thumb-arrow.right-arrow &gt;
        .col-6
          h1(class="inner-title") #{product.title}

          if (product.category)
            div(class="inner-category")
              span Danh mục: 
              a(href=`/products/${product.category.slug}`) #{product.category.title}

          if (product.priceNew)
            div(class="inner-price-new") #{product.priceNew}$

          if (product.price)
            div(class="inner-price-old") #{product.price}$

          if (product.discountPercentage)
            div(class="inner-percent") Giảm tới <span>#{product.discountPercentage}%</span>

          if (product.stock)
            div(class="inner-stock") Còn lại <span>#{product.stock}</span> sản phẩm

          form(
            action=`/cart/add/${product.id}`
            method="POST"
          )
            input(
              class="form-control mb-2"
              type="number"
              name="quantity"
              value="1"
              min="1"
              max=product.stock
            )
            button(
              type="submit"
              class="btn btn-success btn-block"
            ) Thêm vào giỏ hàng

    .container.my-5
      .row
        .col-12
          .card.shadow-sm
            .card-header.text-white(style="background-color: #DB0E0E;")
              h4.mb-0
                i.fa.fa-info-circle.mr-2
                | Mô tả sản phẩm
            .card-body.p-4
              .product-description !{product.description}

    .container.my-5
      .row
        .col-12 
          +box-head("Bình luận")
          
          // Form bình luận
          if (user)
            form.comment-form.mb-4(action=`/products/detail/${product._id}/comments` method="POST")
              .form-group
                label(for="content") 
                  i.fa.fa-pen.mr-2
                  | Viết bình luận của bạn
                textarea.form-control(name="content" id="content" rows="3" placeholder="Chia sẻ suy nghĩ của bạn về sản phẩm này..." required)
              button.btn.btn-primary.mt-2(type="submit")
                i.fa.fa-paper-plane.mr-2
                | Gửi bình luận
          else
            .alert.alert-info.mb-4
              i.fa.fa-info-circle.mr-2
              | Bạn cần 
              a(href="/user/login") đăng nhập 
              | để bình luận về sản phẩm này.

          // Hiển thị danh sách bình luận
          .comment-section.my-4
            h5.comment-counter.mb-3
              i.fa.fa-comments.mr-2
              | Tất cả bình luận (#{product.comments.length})
            
            if (product.comments.length > 0)
              // Sắp xếp bình luận mới nhất lên trên
              - const sortedComments = [...product.comments].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
              .comment-list
                each comment in sortedComments
                  .comment-item.mb-4
                    .comment-header.d-flex.justify-content-between.align-items-center
                      .user-info
                        if comment.user
                          i.fa.fa-user-circle.mr-2
                          strong.text-primary #{comment.user.fullName}
                        else
                          i.fa.fa-user-circle.mr-2
                          strong.text-secondary Người dùng ẩn danh
                      small.text-muted
                        i.fa.fa-clock.mr-1
                        | #{new Date(comment.createdAt).toLocaleString('vi-VN')}
                    .comment-content.mt-2.p-3.border.rounded.bg-light
                      | #{comment.content}
            else
              .alert.alert-light.text-center.py-4.border
                i.fa.fa-comment-slash.fa-2x.mb-3.text-muted
                p.mb-0 Chưa có bình luận nào cho sản phẩm này.
                p.mb-0 Hãy là người đầu tiên bình luận!

    // Thêm các liên kết CSS và JS của Swiper
    link(rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css")
    script(src="https://unpkg.com/swiper/swiper-bundle.min.js")

    script.
      document.addEventListener('DOMContentLoaded', () => {
        const mainImage = document.getElementById('main-image');
        const thumbImages = document.querySelectorAll('.swiper-slide .product-image');
        const leftMainArrow = document.querySelector('.left-main-arrow');
        const rightMainArrow = document.querySelector('.right-main-arrow');

        let currentIndex = 0;
        
        // Tạo mảng tất cả ảnh (ảnh chính + ảnh phụ)
        const allImages = [];
        
        // Thêm ảnh chính vào đầu mảng
        allImages.push('#{product.thumbnail}');
        
        // Thêm các ảnh khác (nếu khác với ảnh chính)
        const productImages = !{JSON.stringify(product.images || [])};
        productImages.forEach(image => {
          if (image !== '#{product.thumbnail}') {
            allImages.push(image);
          }
        });

        const updateMainImage = (index) => {
          if (index >= 0 && index < allImages.length) {
            mainImage.src = allImages[index];
            
            // Cập nhật class selected cho ảnh thumb
            thumbImages.forEach(thumb => thumb.classList.remove('selected'));
            if (thumbImages[index]) {
              thumbImages[index].classList.add('selected');
            }
            
            currentIndex = index;
            swiper.slideTo(index); // Di chuyển Swiper đến ảnh tương ứng
            updateArrowsVisibility();
          }
        };

        // Click vào ảnh thumbnail để thay đổi ảnh chính
        thumbImages.forEach((thumb, index) => {
          thumb.addEventListener('click', () => {
            updateMainImage(index);
          });
        });

        const swiper = new Swiper('.swiper-container', {
          navigation: {
            nextEl: '.right-arrow',
            prevEl: '.left-arrow',
          },
          slidesPerView: 5,
          spaceBetween: 5,
        });

        const updateArrowsVisibility = () => {
          if (allImages.length <= 1) {
            leftMainArrow.style.display = 'none';
            rightMainArrow.style.display = 'none';
            return;
          } else {
            leftMainArrow.style.display = 'block';
            rightMainArrow.style.display = 'block';
          }

          if (currentIndex === 0) {
            leftMainArrow.classList.add('disabled');
          } else {
            leftMainArrow.classList.remove('disabled');
          }

          if (currentIndex === allImages.length - 1) {
            rightMainArrow.classList.add('disabled');
          } else {
            rightMainArrow.classList.remove('disabled');
          }
        };

        // Điều hướng ảnh chính bằng arrow
        leftMainArrow.addEventListener('click', () => {
          if (currentIndex > 0) {
            updateMainImage(currentIndex - 1);
          }
        });

        rightMainArrow.addEventListener('click', () => {
          if (currentIndex < allImages.length - 1) {
            updateMainImage(currentIndex + 1);
          }
        });

        // Khởi tạo ban đầu
        updateArrowsVisibility();
        
        // Đảm bảo ảnh đầu tiên được chọn
        if (thumbImages.length > 0) {
          thumbImages[0].classList.add('selected');
        }
      });

    style.
      .product-image.selected {
        border: 3px solid #DB0E0E;
        border-radius: 5px;
        opacity: 1;
      }
      
      .product-image {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        border-radius: 5px;
        opacity: 0.7;
      }
      
      .product-image:hover {
        opacity: 1;
        border-color: #DB0E0E;
      }
      
      .main-arrow {
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        border-radius: 5px;
        transition: background 0.3s ease;
      }
      
      .main-arrow:hover:not(.disabled) {
        background: rgba(0, 0, 0, 0.8);
      }
      
      .main-arrow.disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      
      .left-main-arrow {
        left: 10px;
      }
      
      .right-main-arrow {
        right: 10px;
      }
      
      .inner-thumb {
        position: relative;
        text-align: center;
        margin-bottom: 20px;
      }
      
      #main-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .product-description img {
        max-width: 100% !important;
        height: auto !important;
        object-fit: contain;
        border-radius: 8px;
        margin: 15px auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: block;
      }
      
      .product-description {
        overflow-x: auto;
        word-wrap: break-word;
        line-height: 1.6;

      }
      
      .product-description p {
        margin-bottom: 15px;
        text-align: left;
      }
      
      .product-description * {
        max-width: 100% !important;
      }
      
      .product-description h1, 
      .product-description h2, 
      .product-description h3 {
        color: #333;
        margin-top: 20px;
        margin-bottom: 10px;
      }